{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///home/am-pc-14/Documents/pp/react_chat/chat-frontend/app/chat/page.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useRef, useState } from 'react';\nimport { io, Socket } from 'socket.io-client';\n\nlet socket: Socket | null = null;\n\nexport default function ChatPage() {\n  const [connected, setConnected] = useState(false);\n  const [email, setEmail] = useState('');\n  const [name, setName] = useState('');\n  const [target, setTarget] = useState('');\n  const [isGroup, setIsGroup] = useState(false);\n  const [messages, setMessages] = useState<any[]>([]);\n  const [text, setText] = useState('');\n  const [currentRoom, setCurrentRoom] = useState<string | null>(null);\n  const [chats, setChats] = useState<any[]>([]);\n  const [directChats, setDirectChats] = useState<any[]>([]);\n  const [newChatEmail, setNewChatEmail] = useState('');\n  const mounted = useRef(false);\n  const messagesRef = useRef<HTMLDivElement | null>(null);\n\n  useEffect(() => {\n    mounted.current = true;\n    // restore user from localStorage and auto-connect\n    try {\n      const u = localStorage.getItem('user');\n      if (u) {\n        const parsed = JSON.parse(u);\n        setEmail(parsed.email || '');\n        setName(parsed.name || '');\n        // auto-connect\n        setTimeout(() => {\n          if (!connected) connect();\n        }, 100);\n      }\n    } catch (e) {}\n    fetchChats();\n    return () => { mounted.current = false; if (socket) socket.disconnect(); };\n  }, []);\n\n  useEffect(() => {\n    // scroll to bottom when messages change\n    const el = messagesRef.current;\n    if (el) el.scrollTop = el.scrollHeight;\n  }, [messages]);\n\n  async function fetchChats() {\n    try {\n      const base = process.env.NEXT_PUBLIC_BACKEND_URL ?? 'http://localhost:5000';\n      const res = await fetch(`${base}/groups`);\n      if (res.ok) {\n        const list = await res.json();\n        setChats(list || []);\n      }\n    } catch (e) { /* ignore */ }\n  }\n\n  function createDirectChat() {\n    const e = newChatEmail.trim().toLowerCase();\n    if (!e) return alert('enter an email');\n    if (e === email) return alert('Cannot start a chat with yourself');\n    if (directChats.find((d) => d.email === e)) {\n      openChat({ type: 'direct', email: e });\n      setNewChatEmail('');\n      return;\n    }\n    const item = { type: 'direct', email: e, name: e };\n    setDirectChats((s) => [item, ...s]);\n    openChat(item);\n    setNewChatEmail('');\n  }\n\n  function connect() {\n    if (!email) return alert('enter email');\n    socket = io(process.env.NEXT_PUBLIC_BACKEND_URL ?? 'http://localhost:5000', { transports: ['websocket'] });\n    socket.on('connect', () => {\n      setConnected(true);\n      socket?.emit('identify', { email });\n    });\n    socket.on('message', (m) => {\n      setMessages((s) => [...s, m]);\n    });\n    socket.on('disconnect', () => setConnected(false));\n  }\n\n  function openChat(item: any) {\n    // leave previous room if any\n    if (socket && currentRoom) {\n      socket.emit('leave', { room: currentRoom });\n    }\n\n    if (item.type === 'group') {\n      setIsGroup(true);\n      setTarget(item.id);\n      const room = `group:${item.id}`;\n      // join group room so we receive group messages\n      socket?.emit('join', { room });\n      setCurrentRoom(room);\n    } else {\n      setIsGroup(false);\n      setTarget(item.email);\n      // private room naming must match backend\n      const me = email;\n      const arr = [me, item.email].sort();\n      const room = `private:${arr[0]}|${arr[1]}`;\n      socket?.emit('join', { room });\n      setCurrentRoom(room);\n    }\n    setMessages([]);\n  }\n\n  function send() {\n    if (!socket) return alert('connect first');\n    if (!target) return alert('select a chat or enter a target');\n    const payload = { from: email, to: target || undefined, text, isGroup };\n    socket.emit('message', payload);\n    // rely on server broadcast to deliver the message (prevents duplicate local echo)\n    setText('');\n  }\n\n  async function createGroup() {\n    if (!target) return alert('provide group id');\n    const base = process.env.NEXT_PUBLIC_BACKEND_URL ?? 'http://localhost:5000';\n    const res = await fetch(`${base}/groups/create`, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ id: target, name: target, creator: email }),\n    });\n    const j = await res.json();\n    alert(JSON.stringify(j));\n    fetchChats();\n  }\n\n  return (\n    <div className=\"chat-app\">\n      <div className=\"sidebar\">\n        <div className=\"header\">My Chat</div>\n        <div className=\"search\">\n          <input placeholder=\"Search chats\" style={{ width: '100%', padding: 8, borderRadius: 8, border: '1px solid #eee' }} />\n        </div>\n\n        <div style={{ padding: 12, borderBottom: '1px solid #f4f4f4' }}>\n          <div style={{ fontSize: 13, color: '#444', fontWeight: 600, marginBottom: 8 }}>New chat</div>\n          <div style={{ display: 'flex', gap: 8 }}>\n            <input placeholder=\"Email address\" value={newChatEmail} onChange={(e) => setNewChatEmail(e.target.value)} style={{ flex: 1, padding: 8, borderRadius: 8, border: '1px solid #eee' }} />\n            <button onClick={createDirectChat} className=\"send-btn\" style={{ padding: '8px 12px' }}>Start</button>\n          </div>\n        </div>\n\n        <div className=\"chats\">\n          <div style={{ padding: 12, fontWeight: 700 }}>Groups</div>\n          {chats.map((g: any) => (\n            <div key={g.id} className=\"chat-item\" onClick={() => openChat({ type: 'group', id: g.id })}>\n              <div className=\"avatar\">{g.name?.[0]?.toUpperCase() ?? 'G'}</div>\n              <div>\n                <div style={{ fontWeight: 600 }}>{g.name}</div>\n                <div style={{ fontSize: 12, color: '#666' }}>{g.members?.slice(0,2).join(', ')}</div>\n              </div>\n            </div>\n          ))}\n          <div style={{ padding: 12, fontWeight: 700 }}>Direct Chats</div>\n          {directChats.map((d: any) => (\n            <div key={d.email} className=\"chat-item\" onClick={() => openChat({ type: 'direct', email: d.email })}>\n              <div className=\"avatar\">{d.name?.[0]?.toUpperCase() ?? d.email?.[0]?.toUpperCase() ?? 'U'}</div>\n              <div>\n                <div style={{ fontWeight: 600 }}>{d.name || d.email}</div>\n                <div style={{ fontSize: 12, color: '#666' }}>{d.email}</div>\n              </div>\n            </div>\n          ))}\n        </div>\n      </div>\n\n      <div className=\"chat-window\">\n        <div className=\"header\">\n          <div className=\"avatar\">{(target && !isGroup) ? target[0]?.toUpperCase() : (name?.[0]?.toUpperCase() ?? 'C')}</div>\n          <div style={{ fontWeight: 700 }}>{target || 'Select a chat'}</div>\n          <div style={{ marginLeft: 'auto', display: 'flex', alignItems: 'center', gap: 12 }}>\n            <div style={{ textAlign: 'right' }}>\n              {/* <div style={{ fontWeight: 700 }}>{name || 'You'}</div> */}\n              {/* <div style={{ fontSize: 12, color: '#666' }}>{email}</div> */}\n            </div>\n            <button onClick={connect} disabled={connected} className=\"send-btn\" style={{ background: connected ? '#999' : '#128c7e' }}>{connected ? 'Connected' : 'Connect'}</button>\n          </div>\n        </div>\n\n        <div className=\"messages\" ref={messagesRef}>\n          {messages.map((m, i) => {\n            const outgoing = m.from === email;\n            return (\n              <div key={i} className={`message ${outgoing ? 'outgoing' : 'incoming'}`}>\n                <div className=\"bubble\">\n                  <div style={{ fontSize: 13 }}>{m.text}</div>\n                  <div style={{ fontSize: 11, color: '#666', marginTop: 6 }}>{outgoing ? 'You' : m.from}{m.room ? ` â€¢ ${m.room}` : ''}</div>\n                </div>\n              </div>\n            );\n          })}\n        </div>\n\n        <div className=\"input-bar\">\n          <input placeholder=\"Type a message\" value={text} onChange={(e)=>setText(e.target.value)} onKeyDown={(e)=>{ if(e.key==='Enter') send(); }} />\n          <button className=\"send-btn\" onClick={send}>Send</button>\n          <button onClick={createGroup} style={{ marginLeft: 8, borderRadius: 8, padding: '8px 12px' }}>Create Group</button>\n        </div>\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":"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"}}]
}